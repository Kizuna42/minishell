/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   main.c                                             :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: kizuna <kizuna@student.42.fr>              +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/01/25 20:00:00 by kizuna            #+#    #+#             */
/*   Updated: 2025/06/01 18:46:46 by kizuna           ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../includes/minishell.h"

/*
 * 🌐 グローバルシグナル状態変数
 *
 * volatile sig_atomic_t: シグナルハンドラーで安全に使用できる型
 * - Ctrl+C (SIGINT) や Ctrl+\ (SIGQUIT) の状態を保存
 * - シグナル処理中でも安全にアクセス可能
 * - 0: 正常状態, 1: SIGINT受信, 2: SIGQUIT受信
 */
volatile sig_atomic_t	g_signal_status = 0;

/*
 * 🚀 メイン関数 - プログラムのエントリーポイント
 *
 * 実行フロー:
 * 1. シェル構造体の初期化
 * 2. シグナルハンドラーの設定
 * 3. メインループの実行
 * 4. 終了処理とクリーンアップ
 *
 * @param argc: 引数の数（使用しない）
 * @param argv: 引数配列（使用しない）
 * @param envp: 環境変数配列（シェルの環境変数として使用）
 * @return: 最後に実行されたコマンドの終了ステータス
 */
int	main(int argc, char **argv, char **envp)
{
	t_minishell	shell;

	// 📝 未使用引数の明示的な無視
	// minishellは引数を取らないため、コンパイラ警告を回避
	(void)argc;
	(void)argv;

	// 🔧 シェル初期化
	// - 環境変数リストの構築
	// - 標準入出力のバックアップ
	// - 終了ステータスの初期化
	init_minishell(&shell, envp);

	// 📡 シグナルハンドラーの設定
	// - SIGINT (Ctrl+C): 現在のコマンドを中断
	// - SIGQUIT (Ctrl+\): 無視（bashと同じ動作）
	setup_signal_handlers();

	// 🔄 メインループの実行
	// - ユーザー入力の読み取り
	// - コマンドの解析と実行
	// - 終了条件まで継続
	shell.last_exit_status = handle_input_loop(&shell);

	// 🧹 終了処理
	// - 動的メモリの解放
	// - ファイル記述子のクローズ
	// - 環境変数リストのクリーンアップ
	cleanup_minishell(&shell);

	// 📤 最後のコマンドの終了ステータスを返す
	// bashと同じ動作: $? に相当
	return (shell.last_exit_status);
}

/*
 * 💡 設計のポイント:
 *
 * 1. **シンプルなエントリーポイント**
 *    - main()は最小限の処理のみ
 *    - 詳細な処理は各専用関数に委譲
 *
 * 2. **適切なリソース管理**
 *    - 初期化と終了処理のペア
 *    - メモリリークの防止
 *
 * 3. **シグナル処理の分離**
 *    - シグナル関連の処理は専用関数で管理
 *    - グローバル変数での状態管理
 *
 * 4. **bashとの互換性**
 *    - 終了ステータスの適切な処理
 *    - 環境変数の継承
 */
